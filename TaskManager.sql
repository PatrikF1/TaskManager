--DROP TABLE AKTIVNOSTI_PO_ZADACIMA CASCADE CONSTRAINTS;
--DROP TABLE ZADACI CASCADE CONSTRAINTS;
--DROP TABLE STATUSI CASCADE CONSTRAINTS;
--DROP TABLE ZAPOSLENICI CASCADE CONSTRAINTS;

DROP SEQUENCE seq_zaposlenici;
DROP SEQUENCE seq_statusi;
DROP SEQUENCE seq_zadaci;
DROP SEQUENCE seq_apz;

CREATE TABLE ZAPOSLENICI (
    ID                INTEGER NOT NULL,
    IME               VARCHAR2(255) NOT NULL,
    PREZIME           VARCHAR2(255) NOT NULL,
    EMAIL             VARCHAR2(255) NOT NULL,
    SPECIJALIZACIJA   VARCHAR2(255) NOT NULL,
    ID_VODITELJA      INTEGER,
    KOMENTAR          VARCHAR2(2000),
    KORISNIK_KRE      VARCHAR2(255) NOT NULL,
    VRIJEME_KRE       DATE NOT NULL,
    KORISNIK_IZM      VARCHAR2(255),
    VRIJEME_IZM       DATE,
    CONSTRAINT ZAPOSLENICI_PK PRIMARY KEY (ID)
);
ALTER TABLE ZAPOSLENICI ADD CONSTRAINT ZAPOSLENICI_VODITELJ_FK
FOREIGN KEY (ID_VODITELJA) REFERENCES ZAPOSLENICI(ID);

CREATE TABLE STATUSI (
    ID      INTEGER NOT NULL,
    RADNJA  VARCHAR2(255) NOT NULL,
    CONSTRAINT STATUSI_PK PRIMARY KEY (ID)
);

CREATE TABLE ZADACI (
    ID               INTEGER NOT NULL,
    NAZIV            VARCHAR2(255) NOT NULL,
    PROGRAMSKI_JEZIK VARCHAR2(255),
    ID_STATUSA       INTEGER,
    ID_ZAPOSLENIKA   INTEGER,
    CONSTRAINT ZADACI_PK PRIMARY KEY (ID)
);
ALTER TABLE ZADACI ADD CONSTRAINT ZADACI_STATUSI_FK
FOREIGN KEY (ID_STATUSA) REFERENCES STATUSI(ID);
ALTER TABLE ZADACI ADD CONSTRAINT ZADACI_ZAPOSLENICI_FK
FOREIGN KEY (ID_ZAPOSLENIKA) REFERENCES ZAPOSLENICI(ID);

CREATE TABLE AKTIVNOSTI_PO_ZADACIMA (
    ID         INTEGER NOT NULL,
    KOMENTAR   VARCHAR2(255),
    ID_ZADATAK INTEGER NOT NULL,
    CONSTRAINT APZ_PK PRIMARY KEY (ID)
);
ALTER TABLE AKTIVNOSTI_PO_ZADACIMA ADD CONSTRAINT APZ_ZADACI_FK
FOREIGN KEY (ID_ZADATAK) REFERENCES ZADACI(ID);

CREATE SEQUENCE seq_zaposlenici START WITH 122 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE seq_statusi START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE seq_zadaci START WITH 729 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE seq_apz START WITH 1000 INCREMENT BY 1 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER TRG_ZAPOSLENICI
BEFORE INSERT OR UPDATE OR DELETE
ON ZAPOSLENICI
FOR EACH ROW
BEGIN
	IF INSERTING THEN
		:NEW.korisnik_kre := nvl(sys_context('APEX$SESSION','APP_USER'),user);
		:NEW.vrijeme_kre := SYSDATE;
		:NEW.korisnik_izm := NULL;
		:NEW.vrijeme_izm := to_date(NULL);
		IF :NEW.ID IS NULL THEN
			SELECT SEQ_ZAPOSLENICI.NEXTVAL INTO :NEW.ID FROM dual;
		END IF;
	END IF;
	IF UPDATING THEN
		:NEW.korisnik_izm := nvl(sys_context('APEX$SESSION','APP_USER'),user);
		:NEW.vrijeme_izm := SYSDATE;
	END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_STATUSI
BEFORE INSERT OR UPDATE OR DELETE
ON STATUSI
FOR EACH ROW
BEGIN
	IF INSERTING THEN
		IF :NEW.ID IS NULL THEN
			SELECT SEQ_STATUSI.NEXTVAL INTO :NEW.ID FROM dual;
		END IF;
	END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_ZADACI
BEFORE INSERT OR UPDATE OR DELETE
ON ZADACI
FOR EACH ROW
BEGIN
	IF INSERTING THEN
		IF :NEW.ID IS NULL THEN
			SELECT SEQ_ZADACI.NEXTVAL INTO :NEW.ID FROM dual;
		END IF;
	END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_APZ
BEFORE INSERT OR UPDATE OR DELETE
ON AKTIVNOSTI_PO_ZADACIMA
FOR EACH ROW
BEGIN
	IF INSERTING THEN
		IF :NEW.ID IS NULL THEN
			SELECT SEQ_APZ.NEXTVAL INTO :NEW.ID FROM dual;
		END IF;
	END IF;
END;
/

INSERT INTO STATUSI (ID, RADNJA) VALUES (1, 'Upisano');
INSERT INTO STATUSI (ID, RADNJA) VALUES (2, 'U tijeku');
INSERT INTO STATUSI (ID, RADNJA) VALUES (3, 'Završeno');
INSERT INTO STATUSI (ID, RADNJA) VALUES (4, 'Prihvaæeno');
INSERT INTO STATUSI (ID, RADNJA) VALUES (5, 'Otkazano');

INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (100,'Ivan', 'Horvat', 'ivan.horvat@firma.com', 'Direktor', NULL);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (101,'Ana', 'Kovaè', 'ana.kovac@firma.com', 'Razvoj softvera', 100);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (102,'Marko', 'Novak', 'marko.novak@firma.com', 'Testiranje', 100);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (103,'Luka', 'Periæ', 'luka.peric@firma.com', 'Frontend razvoj', 101);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (104,'Maja', 'Šariæ', 'maja.saric@firma.com', 'Backend razvoj', 101);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (105,'Patrik', 'Fabijaniæ', 'p.fabijanic@firma.com', 'SQL Developer', 101);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (106,'David','Tarèuki', 'dtarèuki@firma.com', 'SQL Developer', 101);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (107,'Goran','Oreški', 'goran.oreški@firma.com', 'SQL Developer', 101);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (108,'Ivan','Iviæ', 'ivo.ivic@firma.com', 'SQL Developer', 101);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (109,'Gregor','Mešiæ', 'mesic.g@firma.com', 'Apex Oracle Developer', 101);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (110,'Slaven','Biliæ', 'slaven.bilic3@firma.com', 'Apex Oracle Developer', 101);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (111,'Jakov','Železen', 'jakovzelezen@firma.com', 'QA inženjer', 102);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (112,'Marina','Mrkiæ', 'marina.mrkic12@firma.com', 'Manual tester', 102);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (113,'Igor','Sakiæ', 'igor.s@firma.com', 'Automatizirani tester', 102);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (114,'Tomislav','Atiæ', 'tomaati@firma.com', 'Test analitièar', 102);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (115,'Tamara','Tomiæ', 'ttomich@firma.com', 'UI/UX dizajner', 102);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (116,'Max','Šariæ', 'max.sar@firma.com', 'DevOps inženjer', 100);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (117,'Alen','Asenoviæ', 'asen.alen@firma.com', 'DevOps inženjer', 100);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (118,'Sandra','Jelenoviæ', 'jelensandra@firma.com', 'Cloud inženjer', 116);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (119,'Nikola', 'Dominkoviæ', 'nikola.dom@firma.com', 'Data Scientist', 117);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (120,'Kristina', 'Rajiæ', 'kristina.rajic@firma.com', 'Project Manager', 100);
INSERT INTO ZAPOSLENICI (ID, IME, PREZIME, EMAIL, SPECIJALIZACIJA, ID_VODITELJA) VALUES (121,'Petra', 'Mariæ', 'petra.maric@firma.com', 'Frontend razvoj', 104);

INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (700, 'Izrada login forme', 'PL/SQL', 2, 105);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (701, 'Testiranje baze podataka', 'SQL', 1, 106);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (702, 'API za upravljanje korisnicima', 'Java', 2, 104);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (703, 'Dizajn korisnièkog suèelja', 'HTML/CSS', 3, 103);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (704, 'Pisanje unit testova', 'Java', 1, 114);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (705, 'Optimizacija SQL upita', 'SQL', 2, 107);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (706, 'Integracija platnog servisa', 'Java', 2, 104);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (707, 'Refaktoriranje koda aplikacije', 'PL/SQL', 3, 108);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (708, 'Izrada tehnièke dokumentacije', 'Markdown', 1, 111);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (709, 'Dizajn ikona za suèelje', 'HTML/CSS', 2, 115);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (710, 'Priprema migracijskog plana', 'SQL', 3, 105);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (711, 'Razvoj notifikacijskog sustava', 'Java', 2, 104);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (712, 'Analiza sigurnosnih propusta', 'PL/SQL', 1, 109);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (713, 'Uvoðenje CI/CD pipeline-a', 'Java', 2, 116);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (714, 'Razvoj mobilne aplikacije', 'Java', 1, 104);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (715, 'Implementacija autentikacije dvostrukim faktorom', 'Java', 4, 104);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (716, 'Dizajn nove landing stranice', 'HTML/CSS', 4, 103);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (717, 'Migracija podataka na cloud', 'SQL', 5, 118);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (718, 'Pisanje skripti za automatizaciju builda', 'Python', 5, 116);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (719, 'Razvoj modula za izvještaje', 'SQL', 4, 105);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (720, 'Unapreðenje korisnièke podrške', 'Markdown', 4, 111);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (721, 'Prilagodba aplikacije za mobilne ureðaje', 'HTML/CSS', 5, 115);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (722, 'Testiranje performansi baze', 'SQL', 5, 108);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (723, 'Uvoðenje sustava za verzioniranje', 'Java', 4, 116);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (724, 'Osmišljavanje strategije sigurnosnih kopija', 'PL/SQL', 4, 109);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (725, 'Implementacija analitike', 'Python', 3, 119);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (726, 'Planiranje projekta X', NULL, 2, 120);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (727, 'Prilagodba layouta za RTL jezike', 'HTML/CSS', 2, 121);
INSERT INTO ZADACI (ID, NAZIV, PROGRAMSKI_JEZIK, ID_STATUSA, ID_ZAPOSLENIKA) VALUES (728, 'Generiranje prediktivnih modela', 'Python', 2, 119);

INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1000, 'Dodani testni korisnici u login formu', 700);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1001, 'Uneseni poèetni podaci za testiranje', 701);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1002, 'Dodani endpointi za korisnike', 702);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1003, 'Redizajniran login ekran', 703);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1004, 'Napisani osnovni unit testovi', 704);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1005, 'Optimiziran SELECT upit za izvještaje', 705);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1006, 'Integrirana plaæanja putem PayPala', 706);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1007, 'Uklonjen duplicirani kod', 707);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1008, 'Dodani dijagrami i opis modula', 708);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1009, 'Kreirane SVG ikone', 709);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1010, 'Sastavljen plan koraka migracije', 710);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1011, 'Dodan push notifikacijski kanal', 711);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1012, 'Analiziran SQL Injection rizik', 712);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1013, 'Konfiguriran Jenkins za build', 713);
INSERT INTO AKTIVNOSTI_PO_ZADACIMA (ID, KOMENTAR, ID_ZADATAK) VALUES (1014, 'Dodana podrška za Android verziju', 714);

-- PREGLED TASKOVA SVIH 
CREATE OR REPLACE VIEW PREGLED_TASKOVA AS
SELECT Z.IME, Z.PREZIME, Z.SPECIJALIZACIJA, ZAD.NAZIV, ZAD.PROGRAMSKI_JEZIK, S.RADNJA
FROM ZAPOSLENICI Z
JOIN ZADACI ZAD ON Z.ID = ZAD.ID_ZAPOSLENIKA
JOIN STATUSI S ON ZAD.ID_STATUSA = S.ID;

-- KOMENTARI NA ZADACIMA
CREATE OR REPLACE VIEW KOMENTARI_ZADATAKA AS
SELECT ZAP.IME, ZAP.PREZIME, Z.NAZIV, APZ.KOMENTAR 
FROM AKTIVNOSTI_PO_ZADACIMA APZ
JOIN ZADACI Z ON APZ.ID_ZADATAK = Z.ID
JOIN ZAPOSLENICI ZAP ON Z.ID_ZAPOSLENIKA = ZAP.ID;


    
-- PREGLED ZAPOSLENIKA PO VODITELJIMA
SELECT v.IME || ' ' || v.PREZIME AS IME_VODITELJA,v.SPECIJALIZACIJA AS SEKTOR, LISTAGG(z.IME || ' ' || z.PREZIME, ', ') WITHIN GROUP (ORDER BY z.PREZIME) AS ZAPOSLENICI
FROM ZAPOSLENICI v
JOIN ZAPOSLENICI z ON z.ID_VODITELJA = v.ID
GROUP BY v.IME, v.PREZIME, v.SPECIJALIZACIJA
ORDER BY v.PREZIME;





