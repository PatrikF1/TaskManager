

DROP TABLE aktivnosti_po_zadatku CASCADE CONSTRAINTS;
DROP TABLE zadaci CASCADE CONSTRAINTS;
DROP TABLE statusi CASCADE CONSTRAINTS;
DROP TABLE zaposlenici CASCADE CONSTRAINTS;


CREATE TABLE zaposlenici (
    id_zaposlenik     INT PRIMARY KEY,
    id_voditelj       INT,
    ime               VARCHAR(50) NOT NULL,
    prezime           VARCHAR(50) NOT NULL,
    email             VARCHAR(100) NOT NULL,
    specijalizacija   VARCHAR(100),
    FOREIGN KEY (id_voditelj) REFERENCES zaposlenici(id_zaposlenik) ON DELETE CASCADE
);


CREATE TABLE statusi (
    id_status   INT PRIMARY KEY,
    radnja      VARCHAR(50) NOT NULL
);


CREATE TABLE zadaci (
    id_zadatak         INT PRIMARY KEY,
    naziv              VARCHAR(100) NOT NULL,
    programski_jezik   VARCHAR(50),
    id_status          INT NOT NULL,
    id_zaposlenik      INT NOT NULL,
    FOREIGN KEY (id_status) REFERENCES statusi(id_status),
    FOREIGN KEY (id_zaposlenik) REFERENCES zaposlenici(id_zaposlenik)
);


CREATE TABLE aktivnosti_po_zadatku (
    id_apz       INT PRIMARY KEY,
    id_zadatak   INT NOT NULL,
    komentar     CLOB,
    FOREIGN KEY (id_zadatak) REFERENCES zadaci(id_zadatak)
);


CREATE TABLE audit_zadaci (
    audit_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_zadatak INT,
    polje VARCHAR2(100),
    stara_vrijednost VARCHAR2(4000),
    nova_vrijednost VARCHAR2(4000),
    tko VARCHAR2(100),
    kada DATE
);

ALTER TABLE audit_zadaci
ADD CONSTRAINT fk_audit_zadatak
FOREIGN KEY (id_zadatak)
REFERENCES zadaci(id_zadatak)
ON DELETE CASCADE;


INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (1, NULL, 'Ivan', 'Horvat', 'ivan.horvat@firma.com', 'Direktor');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (2, 1, 'Ana', 'Kovaè', 'ana.kovac@firma.com', 'Razvoj softvera');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (3, 1, 'Marko', 'Novak', 'marko.novak@firma.com', 'Testiranje');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (4, 2, 'Luka', 'Periæ', 'luka.peric@firma.com', 'Frontend razvoj');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (5, 2, 'Maja', 'Šariæ', 'maja.saric@firma.com', 'Backend razvoj');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (6, 2, 'Patrik', 'Fabijaniæ', 'p.fabijanic@firma.com', 'SQL Developer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (7, 2, 'David','Tarèuki', 'dtarèuki@firma.com', 'SQL Developer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (8, 2, 'Goran','Oreški', 'goran.oreški@firma.com', 'SQL Developer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (9, 2, 'Ivan','Iviæ', 'ivo.ivic@firma.com', 'SQL Developer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (10, 2, 'Gregor','Mešiæ', 'mesic.g@firma.com', 'Apex Oracle Developer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (11, 2, 'Slaven','Biliæ', 'slaven.bilic3@firma.com', 'Apex Oracle Developer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (12, 3, 'Jakov','Železen', 'jakovzelezen@firma.com', 'QA inženjer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (13, 3, 'Marina','Mrkiæ', 'marina.mrkic12@firma.com', 'Manual tester');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (14, 3, 'Igor','Sakiæ', 'igor.s@firma.com', 'Automatizirani tester');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (15, 3, 'Tomislav','Atiæ', 'tomaati@firma.com', 'Test analitièar');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (16, 3, 'Tamara','Tomiæ', 'ttomich@firma.com', 'UI/UX dizajner');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (17, 1, 'Max','Šariæ', 'max.sar@firma.com', 'DevOps inženjer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (18, 1, 'Alen','Asenoviæ', 'asen.alen@firma.com', 'DevOps inženjer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (19, 17, 'Sandra','Jelenoviæ', 'jelensandra@firma.com', 'Cloud inženjer');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (20, 18, 'Nikola', 'Dominkoviæ', 'nikola.dom@firma.com', 'Data Scientist');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (21, 1, 'Kristina', 'Rajiæ', 'kristina.rajic@firma.com', 'Project Manager');
INSERT INTO zaposlenici (id_zaposlenik, id_voditelj, ime, prezime, email, specijalizacija) VALUES (22, 5, 'Petra', 'Mariæ', 'petra.maric@firma.com', 'Frontend razvoj');


INSERT INTO statusi (id_status, radnja) VALUES (1, 'Upisano');
INSERT INTO statusi (id_status, radnja) VALUES (2, 'U tijeku');
INSERT INTO statusi (id_status, radnja) VALUES (3, 'Završeno');
INSERT INTO statusi (id_status, radnja) VALUES (4, 'Prihvaæeno');
INSERT INTO statusi (id_status, radnja) VALUES (5, 'Otkazano');


INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (101, 'Izrada login forme', 'PL/SQL', 2, 6);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (102, 'Testiranje baze podataka', 'SQL', 1, 7);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (103, 'API za upravljanje korisnicima', 'Java', 2, 5);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (104, 'Dizajn korisnièkog suèelja', 'HTML/CSS', 3, 4);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (105, 'Pisanje unit testova', 'Java', 1, 14);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (106, 'Optimizacija SQL upita', 'SQL', 2, 8);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (107, 'Integracija platnog servisa', 'Java', 2, 5);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (108, 'Refaktoriranje koda aplikacije', 'PL/SQL', 3, 9);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (109, 'Izrada tehnièke dokumentacije', 'Markdown', 1, 12);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (110, 'Dizajn ikona za suèelje', 'HTML/CSS', 2, 16);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (111, 'Priprema migracijskog plana', 'SQL', 3, 6);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (112, 'Razvoj notifikacijskog sustava', 'Java', 2, 5);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (113, 'Analiza sigurnosnih propusta', 'PL/SQL', 1, 10);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (114, 'Uvoðenje CI/CD pipeline-a', 'Java', 2, 17);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (115, 'Razvoj mobilne aplikacije', 'Java', 1, 5);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (116, 'Implementacija autentikacije dvostrukim faktorom', 'Java', 4, 5);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (117, 'Dizajn nove landing stranice', 'HTML/CSS', 4, 4);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (118, 'Migracija podataka na cloud', 'SQL', 5, 19);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (119, 'Pisanje skripti za automatizaciju builda', 'Python', 5, 17);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (120, 'Razvoj modula za izvještaje', 'SQL', 4, 6);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (121, 'Unapreðenje korisnièke podrške', 'Markdown', 4, 12);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (122, 'Prilagodba aplikacije za mobilne ureðaje', 'HTML/CSS', 5, 16);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (123, 'Testiranje performansi baze', 'SQL', 5, 9);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (124, 'Uvoðenje sustava za verzioniranje', 'Java', 4, 17);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (125, 'Osmišljavanje strategije sigurnosnih kopija', 'PL/SQL', 4, 10);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (126, 'Implementacija analitike', 'Python', 3, 20);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (127, 'Planiranje projekta X', NULL, 2, 21);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (128, 'Prilagodba layouta za RTL jezike', 'HTML/CSS', 2, 22);
INSERT INTO zadaci (id_zadatak, naziv, programski_jezik, id_status, id_zaposlenik) VALUES (129, 'Generiranje prediktivnih modela', 'Python', 2, 20);




INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1001, 101, 'Zapoèeo rad na formi, radi se na validaciji unosa.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1002, 102, 'Priprema testnih podataka.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1003, 103, 'Implementacija CRUD funkcionalnosti.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1004, 104, 'Dizajn završen, èeka se odobrenje.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1005, 105, 'Napisani testovi za osnovne funkcije.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1006, 106, 'Analiza sporih upita u tijeku.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1007, 107, 'Uspostavljena komunikacija s API-em platnog servisa.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1008, 108, 'Kod oèišæen i dokumentiran.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1009, 109, 'Poèetno strukturiranje dokumentacije.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1010, 110, 'Dizajnirane prve ikone.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1011, 111, 'Migracijski plan pripremljen, èeka reviziju.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1012, 112, 'Osnovne notifikacije implementirane.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1013, 113, 'Analiza ranjivosti zapoèeta.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1014, 114, 'Postavljen CI/CD skeleton.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1015, 115, 'Zapoèet rad na backendu.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1020, 116, 'Autentikacija prihvaæena, èeka implementaciju.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1021, 117, 'Dizajn prihvaæen od marketing tima.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1022, 118, 'Migracija otkazana zbog rizika gubitka podataka.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1023, 119, 'Automatizacija otkazana zbog prelaska na novo rješenje.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1024, 120, 'Modul za izvještaje prihvaæen, u fazi planiranja.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1025, 121, 'Podrška unaprijeðena, dokumentacija prihvaæena.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1026, 122, 'Prilagodba otkazana zbog promjene prioriteta.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1027, 123, 'Testiranje otkazano zbog nadogradnje baze.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1028, 124, 'Verzioniranje prihvaæeno od strane voditelja.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1029, 125, 'Strategija sigurnosnih kopija prihvaæena.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1030, 126, 'Analitika pripremljena za inicijalni deployment.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1031, 127, 'Projektna dokumentacija na èekanju.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1032, 128, 'RTL testiranja uspješno prošla.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1033, 129, 'Predikcijski model daje 87% toènosti.');
INSERT INTO aktivnosti_po_zadatku (id_apz, id_zadatak, komentar) VALUES (1034, 130, 'Specifikacije revidirane i komentirane.');








SELECT *
FROM zaposlenici;



-- Top 3 zaposlenika sa specijalizacijom 'SQL Developer' na zadacima u statusu 'U tijeku'

CREATE VIEW slq_devs_u_tijeku AS
SELECT *
FROM (SELECT z.ime, z.prezime, z.specijalizacija, st.radnja 
FROM zaposlenici z
JOIN zadaci s ON z.id_zaposlenik = s.id_zaposlenik
JOIN statusi st ON st.id_status = s.id_status
WHERE z.specijalizacija = 'SQL Developer' AND st.radnja = 'U tijeku')
WHERE ROWNUM <= 3; 

-- DROP VIEW slq_devs_u_tijeku;

SELECT * FROM slq_devs_u_tijeku;





-- aktivnosti po zaposleniku 

CREATE OR REPLACE VIEW v_aktivnosti_po_zaposleniku AS
SELECT zp.ime, zp.prezime, COUNT(apz.id_apz) AS broj_aktivnosti
FROM zaposlenici zp
JOIN zadaci z ON z.id_zaposlenik = zp.id_zaposlenik
JOIN aktivnosti_po_zadatku apz ON apz.id_zadatak = z.id_zadatak
GROUP BY zp.ime, zp.prezime;

SELECT * 
FROM v_aktivnosti_po_zaposleniku;


-- prikaz svih komentara po zadacima 

CREATE OR REPLACE VIEW v_komentari_po_zadacima AS
SELECT zadaci.naziv AS zadatak, COUNT(a.id_apz) AS broj_komentara
FROM zadaci
LEFT JOIN aktivnosti_po_zadatku a ON zadaci.id_zadatak = a.id_zadatak
GROUP BY zadaci.naziv;

SELECT *
FROM v_komentari_po_zadacima;


-- Prikazuje sve zadatke koji su trenutno na èekanju za pregled

SELECT z.id_zadatak, z.naziv, apz.komentar
FROM zadaci z
JOIN aktivnosti_po_zadatku apz ON apz.id_zadatak = z.id_zadatak
WHERE apz.komentar LIKE '%èeka%';


-- zaposlenici sa istim voditeljem 

SELECT id_voditelj, COUNT(*) AS broj_zaposlenika_pod_vodstvom
FROM zaposlenici
WHERE id_voditelj IS NOT NULL
GROUP BY id_voditelj;


-- aktivni zadaci po zaposleniku (znaci samo id 1 i 2)

SELECT z.id_zaposlenik,zp.ime, zp.prezime,COUNT(*) AS broj_aktivnih_zadataka
FROM zadaci z
JOIN zaposlenici zp ON z.id_zaposlenik = zp.id_zaposlenik
WHERE z.id_status >= 3  
GROUP BY z.id_zaposlenik, zp.ime, zp.prezime;


-- koliko zadataka ima JEDAN zaposlenik (posebno svaki zaposlenik)

CREATE OR REPLACE FUNCTION j_zaposlenik (p_zaposlenik_id NUMBER)
RETURN NUMBER IS
    v_broj NUMBER;
    
    BEGIN 
        SELECT COUNT(*) INTO v_broj                       -- spremanje u varijablu v_broj 
        FROM zadaci
        WHERE id_zaposlenik = p_zaposlenik_id;
        
        RETURN v_broj;
    
    END;
/

SELECT j_zaposlenik(6) FROM dual;


-- Koliko su zaposlenici optereæeni
CREATE OR REPLACE VIEW v_zaposlenici_opterecenje AS
SELECT z.id_zaposlenik, z.ime, z.prezime, z.specijalizacija,
COUNT(DISTINCT za.id_zadatak) AS broj_zadataka,
CASE 
WHEN COUNT(DISTINCT za.id_zadatak) < 2 THEN 'Nije optereæen'
ELSE 'Optereæen'
END AS status_opterecenja
FROM zaposlenici z
LEFT JOIN zadaci za ON z.id_zaposlenik = za.id_zaposlenik
LEFT JOIN aktivnosti_po_zadatku apz ON za.id_zadatak = apz.id_zadatak
GROUP BY z.id_zaposlenik, z.ime, z.prezime, z.specijalizacija;

SELECT * FROM v_zaposlenici_opterecenje;


-- zadaci sa statusima za zaposlenika 
SET SERVEROUTPUT ON;


CREATE OR REPLACE PROCEDURE zadaci_sa_statustima (p_zaposlenik_id IN NUMBER)
IS 
    BEGIN
        FOR zadatak_rec IN (                                    -- to ti funkcionira tako sto pretrazuje u upitu, znaci prolazi kroz sve di je z.id_zaposlenik = p_zaposlenik_id i onda loop svih rezultata kako bi napravili ispis 
            SELECT z.naziv, s.radnja
            FROM zadaci z
            JOIN statusi s ON z.id_status = s.id_status
            WHERE z.id_zaposlenik = p_zaposlenik_id
            )
            LOOP
        DBMS_OUTPUT.PUT_LINE('ZADATAK: ' || zadatak_rec.naziv || ' | STATUS: ' || zadatak_rec.radnja);
            END LOOP;       
    END;
    /

BEGIN
    zadaci_sa_statustima(6);
END;
/


SELECT z.naziv, s.radnja
FROM zadaci z
JOIN statusi s ON z.id_status = s.id_status;


SELECT * FROM audit_zadaci; -- napravit cemo trigger kada se unese zadatak da se automatski napuni tablica sa podacima, povezali smo je sa id_zadatak.


